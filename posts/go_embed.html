<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Embedding files in Go</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/b53cc6ef9e9e352d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b53cc6ef9e9e352d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-959cc2ac3c742fb4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ec0fdebf93e8fc69.js" defer=""></script><script src="/_next/static/chunks/996-372da0b0d3708a80.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-959ba1136e063a38.js" defer=""></script><script src="/_next/static/E7MzhBhs3qKTz3zU5oPB4/_buildManifest.js" defer=""></script><script src="/_next/static/E7MzhBhs3qKTz3zU5oPB4/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><h1 id="top">Taras Bunyk</h1><nav><a href="/">Home</a><a href="http://bunyk.github.io/mandala/">Snowflake drawing</a><a href="/resume">Resume</a><a href="https://bunyk.wordpress.com/">Old blog (in Ukrainian)</a></nav><article><h1>Embedding files in Go</h1><div><em>Published: 2021-11-28T21:08:07.000Z</em></div><div><p>Go has a nice property - it compiles to single executable, that could just run. Which does not have depencencies to other packages, does not require runtime or interpreter.</p>
<p>But many of programs could not be built just in Go, and use multiple of different languages that are better fit for their tasks. For example in web you would probably use a lot of SQL, JavaScript, CSS, HTML, JSON, etc... Even desktop apps could use some embedded XML or GLSL, or even CSS for styling.</p>
<p><img src="/content/yo-dawg-code.jpg" alt="Yo dawg, we heard you like coding" title="Put a language in your language"></p>
<p>There are two ways to put such code in your projects: as string literals in Go code, or as separate files. Separate files have advantage of having better modularity, and being more readable (less indentation, and it's easier to highlight file with extension <code>.sql</code> as SQL).</p>
<p>But text files in project that does not contain Go code have huge disadvantage - they are not included into the executable built by compiler, and need to be loaded during runtime. So you need to add them to Docker image, and distribute docker image instead. Or distribute your program in some other package format, that includes both executable and files.</p>
<p>Four years ago I have built a package &#x26; tool to fix that problem and embed text files into go executable as strings: <a href="https://github.com/bunyk/require">https://github.com/bunyk/require</a></p>
<p>In that library you could call <code>require.File("filename.txt")</code>, and it will return content of that file as a string, without actually opening it. There is a <code>hardcode</code> utility that generates go code for each <code>require.File</code> call you have in your codebase to work.</p>
<p>But today I noticed two interesting lines <a href="https://github.com/hismailbulut/neoray/blob/e4baaaf8a09651a4f311a6e50cfb5ed3ec0fae14/src/renderergl.go#L40-L41">in code of Neoray</a> (My GUI of choice for Neovim):</p>
<pre><code class="hljs language-go"><span class="hljs-comment">//go:embed shader.glsl</span>
<span class="hljs-keyword">var</span> EmbeddedShaderSources <span class="hljs-type">string</span></code></pre>
<p>Turns out that since Go 1.16, <a href="https://go.dev/doc/go1.16#library-embed">embed functionality is in standard library</a>. Written by Russ Cox and reviewed by Rob Pike (<a href="https://cs.opensource.google/go/go/+/400581b8b008ece8d0df34f54f281d365a175dba">commit</a>). So, obviously it has better design than my package.</p>
<p>Small downside it has, is that you could use it only with global variables. Using <code>embed</code> directive in function gave me <code>cannot apply to var inside func</code> compilation error. And it does not work with constants, so you need to be careful to not mutate value yourself.</p>
<p>But, that are not really reasons to not deprecate my library. To quote fortune program used as an example:</p>
<blockquote>
<p>One of my most productive days was throwing away 1000 lines of code.  — Ken Thompson</p>
</blockquote>
<pre><code class="hljs language-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	_ <span class="hljs-string">"embed"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"math/rand"</span>
	<span class="hljs-string">"strings"</span>
	<span class="hljs-string">"time"</span>
)

<span class="hljs-comment">//go:embed fortunes.txt</span>
<span class="hljs-keyword">const</span> contents <span class="hljs-type">string</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	fortunes := strings.Split(contents, <span class="hljs-string">"\n"</span>)

	rand.Seed(time.Now().UTC().UnixNano())

	fmt.Println(fortunes[rand.Intn(<span class="hljs-built_in">len</span>(fortunes))])
}</code></pre></div></article><div><div id="disqus_thread"></div></div><nav><a href="/">Home</a><a href="#top">Back to top</a></nav><footer>© <!-- -->2022<!-- --> Bunyk Taras. Built with Next.js</footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"go_embed","title":"Embedding files in Go","date":"2021-11-28T21:08:07.000Z","tags":["go"],"updated_at":"2021-11-28T23:14:56+01:00","content":"\u003cp\u003eGo has a nice property - it compiles to single executable, that could just run. Which does not have depencencies to other packages, does not require runtime or interpreter.\u003c/p\u003e\n\u003cp\u003eBut many of programs could not be built just in Go, and use multiple of different languages that are better fit for their tasks. For example in web you would probably use a lot of SQL, JavaScript, CSS, HTML, JSON, etc... Even desktop apps could use some embedded XML or GLSL, or even CSS for styling.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/content/yo-dawg-code.jpg\" alt=\"Yo dawg, we heard you like coding\" title=\"Put a language in your language\"\u003e\u003c/p\u003e\n\u003cp\u003eThere are two ways to put such code in your projects: as string literals in Go code, or as separate files. Separate files have advantage of having better modularity, and being more readable (less indentation, and it's easier to highlight file with extension \u003ccode\u003e.sql\u003c/code\u003e as SQL).\u003c/p\u003e\n\u003cp\u003eBut text files in project that does not contain Go code have huge disadvantage - they are not included into the executable built by compiler, and need to be loaded during runtime. So you need to add them to Docker image, and distribute docker image instead. Or distribute your program in some other package format, that includes both executable and files.\u003c/p\u003e\n\u003cp\u003eFour years ago I have built a package \u0026#x26; tool to fix that problem and embed text files into go executable as strings: \u003ca href=\"https://github.com/bunyk/require\"\u003ehttps://github.com/bunyk/require\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eIn that library you could call \u003ccode\u003erequire.File(\"filename.txt\")\u003c/code\u003e, and it will return content of that file as a string, without actually opening it. There is a \u003ccode\u003ehardcode\u003c/code\u003e utility that generates go code for each \u003ccode\u003erequire.File\u003c/code\u003e call you have in your codebase to work.\u003c/p\u003e\n\u003cp\u003eBut today I noticed two interesting lines \u003ca href=\"https://github.com/hismailbulut/neoray/blob/e4baaaf8a09651a4f311a6e50cfb5ed3ec0fae14/src/renderergl.go#L40-L41\"\u003ein code of Neoray\u003c/a\u003e (My GUI of choice for Neovim):\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-comment\"\u003e//go:embed shader.glsl\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e EmbeddedShaderSources \u003cspan class=\"hljs-type\"\u003estring\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTurns out that since Go 1.16, \u003ca href=\"https://go.dev/doc/go1.16#library-embed\"\u003eembed functionality is in standard library\u003c/a\u003e. Written by Russ Cox and reviewed by Rob Pike (\u003ca href=\"https://cs.opensource.google/go/go/+/400581b8b008ece8d0df34f54f281d365a175dba\"\u003ecommit\u003c/a\u003e). So, obviously it has better design than my package.\u003c/p\u003e\n\u003cp\u003eSmall downside it has, is that you could use it only with global variables. Using \u003ccode\u003eembed\u003c/code\u003e directive in function gave me \u003ccode\u003ecannot apply to var inside func\u003c/code\u003e compilation error. And it does not work with constants, so you need to be careful to not mutate value yourself.\u003c/p\u003e\n\u003cp\u003eBut, that are not really reasons to not deprecate my library. To quote fortune program used as an example:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eOne of my most productive days was throwing away 1000 lines of code.  — Ken Thompson\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-keyword\"\u003epackage\u003c/span\u003e main\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e (\n\t_ \u003cspan class=\"hljs-string\"\u003e\"embed\"\u003c/span\u003e\n\t\u003cspan class=\"hljs-string\"\u003e\"fmt\"\u003c/span\u003e\n\t\u003cspan class=\"hljs-string\"\u003e\"math/rand\"\u003c/span\u003e\n\t\u003cspan class=\"hljs-string\"\u003e\"strings\"\u003c/span\u003e\n\t\u003cspan class=\"hljs-string\"\u003e\"time\"\u003c/span\u003e\n)\n\n\u003cspan class=\"hljs-comment\"\u003e//go:embed fortunes.txt\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e contents \u003cspan class=\"hljs-type\"\u003estring\u003c/span\u003e\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003emain\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n\tfortunes := strings.Split(contents, \u003cspan class=\"hljs-string\"\u003e\"\\n\"\u003c/span\u003e)\n\n\trand.Seed(time.Now().UTC().UnixNano())\n\n\tfmt.Println(fortunes[rand.Intn(\u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e(fortunes))])\n}\u003c/code\u003e\u003c/pre\u003e"},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"go_embed"},"buildId":"E7MzhBhs3qKTz3zU5oPB4","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>